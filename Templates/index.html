{% extends "base.html" %}

{% block title %}Inicio{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div id="map" style="height: 500px; border: 1px solid #ddd;"></div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Planificar Ruta</h5>
                <form id="routeForm">
                    <div class="mb-3">
                        <label for="origen" class="form-label">Origen:</label>
                        <input type="text" id="origen" name="origen" class="form-control" placeholder="Ingresa el origen" required>
                    </div>
                    <div class="mb-3">
                        <label for="destino" class="form-label">Destino:</label>
                        <input type="text" id="destino" name="destino" class="form-control" placeholder="Ingresa el destino" required>
                    </div>
                    <div class="mb-3">
                        <label for="intervalo_km" class="form-label">Intervalo entre checkpoints (km):</label>
                        <input type="number" id="intervalo_km" name="intervalo_km" class="form-control" value="10" required>
                    </div>
                    <div class="mb-3">
                        <label for="velocidad_promedio" class="form-label">Velocidad promedio (km/h):</label>
                        <input type="number" id="velocidad_promedio" name="velocidad_promedio" class="form-control" value="60" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Calcular Ruta</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const map = L.map('map').setView([0, 0], 2); // Coordenadas iniciales y nivel de zoom

        // Agregar capa de mapa base de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Manejar el formulario de planificación de rutas
        const form = document.getElementById('routeForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const origen = document.getElementById('origen').value;
            const destino = document.getElementById('destino').value;
            const intervalo_km = document.getElementById('intervalo_km').value;
            const velocidad_promedio = document.getElementById('velocidad_promedio').value;

            try {
                const response = await fetch('/calcular_ruta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ origen, destino, intervalo_km, velocidad_promedio })
                });

                const data = await response.json();
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    return;
                }

                // Limpiar el mapa antes de agregar una nueva ruta
                map.eachLayer((layer) => {
                    if (!layer._url) {
                        map.removeLayer(layer);
                    }
                });

                // Mostrar la ruta en el mapa
                const coordinates = data.coordinates;
                const route = L.polyline(coordinates.map(coord => [coord[1], coord[0]]), { color: 'blue' }).addTo(map);
                map.fitBounds(route.getBounds());

                // Mostrar los checkpoints
                const routePoints = data.route_points;
                routePoints.forEach(point => {
                    L.marker([point.lat, point.lon])
                        .addTo(map)
                        .bindPopup(`Km: ${point.kilometro}<br>Tiempo estimado: ${point.tiempo_estimado} horas`);
                });
            } catch (error) {
                console.error(error);
                alert("Ocurrió un error al calcular la ruta.");
            }
        });
    });
</script>
{% endblock %}